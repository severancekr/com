<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>í†µí•© ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <style>
    /* ì‹ ë¢°ê° ê°€ëŠ” í”„ë¦¬ë¯¸ì—„ í…Œë§ˆ ì»¬ëŸ¬ */
    :root { --primary-color: #006670; --secondary-color: #008489; --accent-color: #e6f7f8; --text-color: #2c3e50; --input-border: #cbd5e1; --white: #ffffff; --danger-color: #e74c3c; }
    
    /* â˜… ìš”ì²­í•˜ì‹  ìƒˆë¡œìš´ ë°°ê²½ ì´ë¯¸ì§€ë¡œ ë³€ê²½ ì™„ë£Œ â˜… */
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; background-image: url('https://www.whosaeng.com/imgdata/whosaeng_com/202211/2022112932303587.jpg'); background-size: cover; background-position: center; background-attachment: fixed; color: var(--text-color); display: flex; justify-content: center; align-items: center; }
    
    /* ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ (ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ìœ ë¦¬ì§ˆê° & ê³¡ì„ ) */
    .app-container { width: 100%; max-width: 420px; height: 95vh; margin: 10px; background-color: rgba(255, 255, 255, 0.92); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 24px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); overflow: hidden; display: flex; flex-direction: column; position: relative; border: 1px solid rgba(255,255,255,0.5); }
    
    .screen { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 30px 25px; box-sizing: border-box; }
    .screen.active { display: block; animation: fadeSlideUp 0.4s ease-out; }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* í”„ë¦¬ë¯¸ì—„ í™ˆ ë©”ë‰´ UI */
    .home-header { text-align: center; margin-bottom: 35px; margin-top: 15px; }
    .home-header h1 { color: var(--primary-color); font-size: 26px; font-weight: 800; margin: 0 0 8px 0; letter-spacing: -0.5px; }
    .home-header p { color: #64748b; font-size: 14px; margin: 0; font-weight: 500; }
    
    .menu-grid { display: flex; flex-direction: column; gap: 16px; }
    .menu-card { background: var(--white); border-left: 6px solid var(--secondary-color); border-radius: 16px; padding: 22px 20px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); text-decoration: none; border-top: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
    .menu-card:hover { transform: translateY(-4px); box-shadow: 0 12px 25px rgba(0, 102, 112, 0.15); border-left-color: var(--primary-color); }
    .menu-card:active { transform: translateY(0); }
    .menu-icon { font-size: 32px; margin-right: 18px; background: var(--accent-color); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
    .menu-text { text-align: left; }
    .menu-text h3 { margin: 0 0 4px 0; color: var(--text-color); font-size: 18px; font-weight: 700; }
    .menu-text p { margin: 0; color: #64748b; font-size: 13px; font-weight: 500; }

    /* ì„œë¸Œ í¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .back-btn { background: #f1f5f9; border: none; color: #475569; font-size: 14px; font-weight: 700; cursor: pointer; padding: 8px 16px; border-radius: 20px; margin-bottom: 25px; display: inline-flex; align-items: center; transition: 0.2s; }
    .back-btn:hover { background: #e2e8f0; color: var(--primary-color); }
    .form-header h2 { color: var(--primary-color); margin: 0 0 25px 0; font-size: 22px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
    
    .form-group { margin-bottom: 22px; }
    label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 14px; color: #334155; }
    .required::after { content: "*"; color: var(--danger-color); margin-left: 4px; }
    .time-flex { display: flex; align-items: center; gap: 10px; }
    input[type="text"], input[type="time"], select, textarea, input[type="file"] { width: 100%; padding: 14px; border: 1.5px solid var(--input-border); border-radius: 10px; box-sizing: border-box; font-size: 15px; font-family: inherit; background-color: #f8fafc; transition: all 0.2s; -webkit-appearance: none; color: #0f172a; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); background-color: var(--white); box-shadow: 0 0 0 4px rgba(0, 132, 137, 0.1); }
    input[readonly] { background-color: #e2e8f0; color: #475569; font-weight: bold; border-color: #e2e8f0; cursor: not-allowed; } 
    textarea { resize: none; height: 110px; }
    
    .submit-btn { width: 100%; padding: 16px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.3s; box-shadow: 0 4px 12px rgba(0, 102, 112, 0.2); }
    .submit-btn:hover { background-color: #004d55; transform: translateY(-2px); }
    .undo-btn { width: 100%; padding: 14px; background-color: transparent; color: var(--danger-color); border: 2px solid var(--danger-color); border-radius: 12px; font-size: 15px; font-weight: 700; margin-top: 15px; cursor: pointer; display: none; transition: 0.2s; }
    .undo-btn:hover { background-color: #fef2f2; }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); backdrop-filter: blur(5px); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 4px solid #e2e8f0; width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite; margin-bottom: 15px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><p style="color: #006670; font-weight: 700;">ì•ˆì „í•˜ê²Œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...</p></div>

    <div id="homeScreen" class="screen active">
      <div class="home-header">
        <h1>í†µí•© ì—…ë¬´ ì‹œìŠ¤í…œ</h1>
        <p>ì •í™•í•˜ê³  ì‹ ì†í•œ ìŠ¤ë§ˆíŠ¸ ë³´ê³  ì±„ë„</p>
      </div>
      
      <div class="menu-grid">
        <div class="menu-card" onclick="showScreen('form1Screen')">
          <div class="menu-icon">ğŸ“‹</div>
          <div class="menu-text">
            <h3>ìƒí™© ë³´ê³ </h3>
            <p>í™˜ìë™í–‰, ë³‘ë™/ì™¸ë˜ ì‚¬ê³  ì§€ì›</p>
          </div>
        </div>
        
        <div class="menu-card" onclick="showScreen('form2Screen')">
          <div class="menu-icon">ğŸ”¦</div>
          <div class="menu-text">
            <h3>ë¯¸ì‹œê±´ ë° ì†Œë“±</h3>
            <p>ë¶€ì„œë³„ ì•¼ê°„ ë³´ì•ˆ/ì†Œë“± ì ê²€</p>
          </div>
        </div>
        
        <div class="menu-card" onclick="showScreen('form3Screen')">
          <div class="menu-icon">ğŸ› ï¸</div>
          <div class="menu-text">
            <h3>ì‘ì—… í˜„í™©</h3>
            <p>ì‹œì„¤ ì ê²€ ë° ê¸°íƒ€ ë¶€ì„œë³„ ì‘ì—…</p>
          </div>
        </div>
      </div>
    </div>

    <div id="form1Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë©”ì¸ìœ¼ë¡œ</button>
      <div class="form-header"><h2>ìƒí™© ë³´ê³  ì‘ì„±</h2></div>
      
      <form id="reportForm">
        <div class="form-group"><label>1. ë‚ ì§œ (ìë™ì…ë ¥)</label><input type="text" class="auto-date" readonly></div>

        <div class="form-group">
          <label class="required">2. ìœ í˜•</label>
          <select id="typeSelect" required>
            <option value="" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="ì™¸ë˜">ì™¸ë˜</option><option value="ë³‘ë™">ë³‘ë™</option>
            <option value="ì™¸ë¶€">ì™¸ë¶€</option><option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
          <input type="text" id="customType" placeholder="ìœ í˜• ì§ì ‘ ì…ë ¥" style="display:none; margin-top:8px;">
        </div>

        <div class="form-group">
          <label class="required">3. ì˜ˆë°©ë‚´ì—­</label>
          <select id="preventionSelect" required>
            <option value="" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="í™˜ìë™í–‰">í™˜ìë™í–‰</option><option value="ìƒí™©ì¶œë™">ìƒí™©ì¶œë™</option>
            <option value="í™˜ìì´íƒˆ">í™˜ìì´íƒˆ</option><option value="ê³ ì¸ì´ì†¡">ê³ ì¸ì´ì†¡</option>
            <option value="ì±„í˜ˆì§€ì›">ì±„í˜ˆì§€ì›</option><option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
          <input type="text" id="customPrevention" placeholder="ì˜ˆë°©ë‚´ì—­ ì§ì ‘ ì…ë ¥" style="display:none; margin-top:8px;">
        </div>

        <div class="form-group"><label class="required">4. ê·¼ë¬´ì</label><input type="text" id="worker1" class="sync-worker" placeholder="ì˜ˆ) í™ê¸¸ë™ ì™¸ 1ëª…" required></div>
        <div class="form-group"><label class="required">5. ì‚¬ê³ ì</label><input type="text" id="patientInput" placeholder="ì˜ˆ) ê¹€ì² ìˆ˜(69/ë‚¨)" required></div>
        <div class="form-group"><label class="required">6. ì¡°ì¹˜ê²°ê³¼</label><textarea id="resultInput" placeholder="ì¡°ì¹˜í•˜ì‹  ê²°ê³¼ë¥¼ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”." required></textarea></div>
        
        <div class="form-group">
          <label class="required">7. ì—…ë¬´ ì‹œê°„ (ì‹œì‘ ~ ì¢…ë£Œ)</label>
          <div class="time-flex">
            <input type="time" id="startTime1" required><span>~</span><input type="time" id="endTime1" required>
          </div>
        </div>

        <div class="form-group"><label>8. ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label><input type="file" id="photo1" accept="image/*"></div>

        <button type="submit" class="submit-btn">ë³´ê³  ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn1">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

    <div id="form2Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë©”ì¸ìœ¼ë¡œ</button>
      <div class="form-header"><h2>ë¯¸ì‹œê±´ ë° ì†Œë“± ì ê²€</h2></div>
      
      <form id="form2">
        <div class="form-group"><label>1. ë‚ ì§œ (ìë™ì…ë ¥)</label><input type="text" class="auto-date" readonly></div>
        <div class="form-group"><label class="required">2. ê·¼ë¬´ì</label><input type="text" id="worker2" class="sync-worker" placeholder="ê·¼ë¬´ì ì´ë¦„ ì…ë ¥" required></div>
        <div class="form-group"><label class="required">3. ì™¸ë˜ë¯¸ì‹œê±´ë¯¸ì†Œë“±</label><textarea id="content2" placeholder="ì˜ˆ) 5ì¸µ ê·¼ì „ë„ì‹¤ 1,2 ë¯¸ì‹œê±´" required></textarea></div>
        <div class="form-group"><label class="required">4. í™•ì¸ì‹œê°„</label><input type="time" id="checkTime2" required></div>
        <div class="form-group"><label>5. ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label><input type="file" id="photo2" accept="image/*"></div>
        
        <button type="submit" class="submit-btn">ì ê²€ ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn2">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

    <div id="form3Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë©”ì¸ìœ¼ë¡œ</button>
      <div class="form-header"><h2>ì‘ì—… í˜„í™© ë³´ê³ </h2></div>
      
      <form id="form3">
        <div class="form-group"><label>1. ë‚ ì§œ (ìë™ì…ë ¥)</label><input type="text" class="auto-date" readonly></div>
        <div class="form-group"><label class="required">2. ê·¼ë¬´ì</label><input type="text" id="worker3" class="sync-worker" placeholder="ê·¼ë¬´ì ì´ë¦„ ì…ë ¥" required></div>
        <div class="form-group"><label class="required">3. ë¶€ì„œì‘ì—…í˜„í™©</label><textarea id="content3" placeholder="ì‘ì—…í•˜ì‹  ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required></textarea></div>
        <div class="form-group"><label class="required">4. í™•ì¸ì‹œê°„</label><input type="time" id="checkTime3" required></div>
        <div class="form-group"><label>5. ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label><input type="file" id="photo3" accept="image/*"></div>
        
        <button type="submit" class="submit-btn">í˜„í™© ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn3">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

  </div>

  <script>
    // â˜… ê¸°ì¡´ì— ì˜ ì‘ë™í•˜ë˜ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ 'ì›¹ ì•± URL'ì„ ì´ê³³ì— ë‹¤ì‹œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxK9_OtEHMpThIjXP6bUwi5j_cEMoFN9tDsd69qavXceqnq8fxWzJruMYpreuk8dUMS7A/exec';
    
    let lastUuid1 = null; let lastUuid2 = null; let lastUuid3 = null;
    const kstOffset = 9 * 60;

    function getFormattedDate() {
      const now = new Date(); now.setMinutes(now.getMinutes() + kstOffset);
      return `${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}(${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][now.getDay()]})`;
    }
    function getCurrentTime() { const d = new Date(); d.setMinutes(d.getMinutes() + kstOffset); return d.toISOString().split('T')[1].substring(0,5); }
    function getEndTime() { const d = new Date(); d.setMinutes(d.getMinutes() + kstOffset + 15); return d.toISOString().split('T')[1].substring(0,5); }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    window.addEventListener('load', () => {
      document.querySelectorAll('.auto-date').forEach(el => el.value = getFormattedDate());
      document.getElementById('startTime1').value = getCurrentTime();
      document.getElementById('endTime1').value = getEndTime();
      document.getElementById('checkTime2').value = getCurrentTime();
      document.getElementById('checkTime3').value = getCurrentTime();

      const savedWorker = localStorage.getItem('autosave_worker');
      if(savedWorker) { document.querySelectorAll('.sync-worker').forEach(el => el.value = savedWorker); }
    });

    document.querySelectorAll('.sync-worker').forEach(input => {
      input.addEventListener('input', function() {
        localStorage.setItem('autosave_worker', this.value);
        document.querySelectorAll('.sync-worker').forEach(el => el.value = this.value);
      });
    });

    function handleDirectInput(selectId, inputId) {
      document.getElementById(selectId).addEventListener('change', function() {
        const input = document.getElementById(inputId);
        if(this.value === 'ì§ì ‘ì…ë ¥') { input.style.display = 'block'; input.required = true; } 
        else { input.style.display = 'none'; input.required = false; input.value = ''; }
      });
    }
    handleDirectInput('typeSelect', 'customType');
    handleDirectInput('preventionSelect', 'customPrevention');

    async function submitForm(sheetName, dataObj, photoInputId, undoBtnId) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      const fileInput = document.getElementById(photoInputId);
      
      const handleFile = () => new Promise((resolve) => {
        const file = fileInput.files[0];
        if (!file) { resolve(); return; }
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > 1024) { h = Math.round(h * 1024 / w); w = 1024; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            dataObj.fileData = canvas.toDataURL('image/jpeg', 0.8);
            dataObj.fileName = file.name; resolve();
          }; img.src = e.target.result;
        }; reader.readAsDataURL(file);
      });

      try {
        await handleFile();
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dataObj) });
        alert(sheetName + ' ë“±ë¡ ì™„ë£Œ!');
        document.getElementById(undoBtnId).style.display = 'block';
        return true;
      } catch (error) { alert('ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); return false; } 
      finally { document.getElementById('loadingOverlay').style.display = 'none'; }
    }

    document.getElementById('reportForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      let type = document.getElementById('typeSelect').value; if (type === 'ì§ì ‘ì…ë ¥') type = document.getElementById('customType').value;
      let prev = document.getElementById('preventionSelect').value; if (prev === 'ì§ì ‘ì…ë ¥') prev = document.getElementById('customPrevention').value;

      lastUuid1 = Date.now().toString(36);
      const data = {
        action: 'insert', sheetName: 'ìƒí™©ë³´ê³ ', uuid: lastUuid1,
        date: document.querySelectorAll('.auto-date')[0].value,
        type: type, prevention: prev,
        worker: document.getElementById('worker1').value,
        patient: document.getElementById('patientInput').value,
        resultText: document.getElementById('resultInput').value,
        timeRange: `${document.getElementById('startTime1').value}~${document.getElementById('endTime1').value}`
      };

      if(await submitForm('ìƒí™©ë³´ê³ ', data, 'photo1', 'undoBtn1')) {
        this.reset();
        document.querySelectorAll('.auto-date')[0].value = getFormattedDate();
        document.getElementById('startTime1').value = getCurrentTime(); document.getElementById('endTime1').value = getEndTime();
        document.getElementById('worker1').value = localStorage.getItem('autosave_worker');
        document.getElementById('customType').style.display = 'none'; document.getElementById('customPrevention').style.display = 'none';
      }
    });

    document.getElementById('form2').addEventListener('submit', async function(e) {
      e.preventDefault(); lastUuid2 = Date.now().toString(36);
      const data = {
        action: 'insert', sheetName: 'ë¯¸ì‹œê±´ë°ì†Œë“±', uuid: lastUuid2,
        date: document.querySelectorAll('.auto-date')[1].value,
        worker: document.getElementById('worker2').value,
        content: document.getElementById('content2').value,
        checkTime: document.getElementById('checkTime2').value
      };
      if(await submitForm('ë¯¸ì‹œê±´ë°ì†Œë“±', data, 'photo2', 'undoBtn2')) {
        this.reset();
        document.querySelectorAll('.auto-date')[1].value = getFormattedDate();
        document.getElementById('checkTime2').value = getCurrentTime();
        document.getElementById('worker2').value = localStorage.getItem('autosave_worker');
      }
    });

    document.getElementById('form3').addEventListener('submit', async function(e) {
      e.preventDefault(); lastUuid3 = Date.now().toString(36);
      const data = {
        action: 'insert', sheetName: 'ì‘ì—…í˜„í™©', uuid: lastUuid3,
        date: document.querySelectorAll('.auto-date')[2].value,
        worker: document.getElementById('worker3').value,
        content: document.getElementById('content3').value,
        checkTime: document.getElementById('checkTime3').value
      };
      if(await submitForm('ì‘ì—…í˜„í™©', data, 'photo3', 'undoBtn3')) {
        this.reset();
        document.querySelectorAll('.auto-date')[2].value = getFormattedDate();
        document.getElementById('checkTime3').value = getCurrentTime();
        document.getElementById('worker3').value = localStorage.getItem('autosave_worker');
      }
    });

    async function handleUndo(sheetName, uuid, btnId) {
      if(!confirm('ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      document.getElementById('loadingOverlay').style.display = 'flex';
      try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', sheetName: sheetName, uuid: uuid }) });
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); document.getElementById(btnId).style.display = 'none';
      } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } finally { document.getElementById('loadingOverlay').style.display = 'none'; }
    }
    
    document.getElementById('undoBtn1').addEventListener('click', () => handleUndo('ìƒí™©ë³´ê³ ', lastUuid1, 'undoBtn1'));
    document.getElementById('undoBtn2').addEventListener('click', () => handleUndo('ë¯¸ì‹œê±´ë°ì†Œë“±', lastUuid2, 'undoBtn2'));
    document.getElementById('undoBtn3').addEventListener('click', () => handleUndo('ì‘ì—…í˜„í™©', lastUuid3, 'undoBtn3'));
  </script>
</body>
</html>
