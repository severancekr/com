<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>í†µí•© ì—…ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <style>
    :root { --primary-color: #008489; --secondary-color: #005c61; --text-color: #333333; --input-border: #d1dce5; --white: #ffffff; --bg-gray: #f4f7f9; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; background-image: url('https://ksnnews.or.kr/news/data/2025/03/11/p1065595035371594_319_thum.png'); background-size: cover; background-position: center; background-attachment: fixed; color: var(--text-color); display: flex; justify-content: center; align-items: center; }
    
    /* ì•± í™”ë©´ ì»¨í…Œì´ë„ˆ */
    .app-container { width: 100%; max-width: 420px; height: 95vh; margin: 10px; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; display: flex; flex-direction: column; position: relative; }
    
    /* í™”ë©´ ì „í™˜ìš© í´ë˜ìŠ¤ */
    .screen { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 25px; box-sizing: border-box; }
    .screen.active { display: block; animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* í™ˆ í™”ë©´(ë©”ë‰´) ìŠ¤íƒ€ì¼ */
    .home-header { text-align: center; margin-bottom: 40px; margin-top: 20px; }
    .home-header h1 { color: var(--primary-color); font-size: 24px; margin: 0 0 10px 0; }
    .menu-btn { width: 100%; background-color: var(--white); border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; font-size: 18px; font-weight: 700; color: var(--primary-color); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .menu-btn:hover { background-color: var(--primary-color); color: var(--white); }
    
    /* ì„œë¸Œ í¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .back-btn { background: none; border: none; color: #555; font-size: 16px; font-weight: 600; cursor: pointer; padding: 0; margin-bottom: 20px; display: flex; align-items: center; }
    .form-header h2 { color: var(--primary-color); margin: 0 0 20px 0; font-size: 20px; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 15px; }
    
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
    input[type="text"], select, textarea, input[type="file"] { width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; box-sizing: border-box; font-size: 15px; font-family: inherit; background-color: var(--white); -webkit-appearance: none; }
    input[readonly] { background-color: #f0f0f0; color: #555; font-weight: bold; } /* ìë™ì…ë ¥ ë‚ ì§œì¹¸ */
    textarea { resize: none; height: 100px; }
    .submit-btn { width: 100%; padding: 14px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    .undo-btn { width: 100%; padding: 12px; background-color: var(--white); color: var(--danger-color); border: 1px solid var(--danger-color); border-radius: 8px; font-size: 14px; font-weight: 700; margin-top: 15px; cursor: pointer; display: none; }

    .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 4px solid rgba(0, 132, 137, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><p style="color: #008489; font-weight: 600;">ë°ì´í„° ì „ì†¡ ì¤‘...</p></div>

    <div id="homeScreen" class="screen active">
      <div class="home-header">
        <h1>í†µí•© ì—…ë¬´ ì‹œìŠ¤í…œ</h1>
        <p style="color:#666; font-size:14px;">ì›í•˜ì‹œëŠ” ì—…ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
      </div>
      <button class="menu-btn" onclick="showScreen('form1Screen')">ğŸ“‹ ìƒí™© ë³´ê³ </button>
      <button class="menu-btn" onclick="showScreen('form2Screen')">ğŸ”¦ ë¯¸ì‹œê±´ ë° ì†Œë“±</button>
      <button class="menu-btn" onclick="showScreen('form3Screen')">ğŸ› ï¸ ì‘ì—… í˜„í™©</button>
    </div>

    <div id="form1Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë’¤ë¡œ ê°€ê¸°</button>
      <div class="form-header"><h2>ìƒí™© ë³´ê³  ì‘ì„±</h2></div>
      
      <form id="reportForm">
        <div class="form-group">
          <label>1. ë‚ ì§œ (ìë™ì…ë ¥)</label>
          <input type="text" id="dateDisplay" readonly>
        </div>

        <div class="form-group">
          <label>2. ìœ í˜•</label>
          <select id="typeSelect" required>
            <option value="" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="ì™¸ë˜">ì™¸ë˜</option><option value="ë³‘ë™">ë³‘ë™</option>
            <option value="ì™¸ë¶€">ì™¸ë¶€</option><option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
          <input type="text" id="customType" placeholder="ìœ í˜• ì§ì ‘ ì…ë ¥" style="display:none; margin-top:8px;">
        </div>

        <div class="form-group">
          <label>3. ì˜ˆë°©ë‚´ì—­</label>
          <select id="preventionSelect" required>
            <option value="" disabled selected>ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="í™˜ìë™í–‰">í™˜ìë™í–‰</option><option value="ìƒí™©ì¶œë™">ìƒí™©ì¶œë™</option>
            <option value="í™˜ìì´íƒˆ">í™˜ìì´íƒˆ</option><option value="ê³ ì¸ì´ì†¡">ê³ ì¸ì´ì†¡</option>
            <option value="ì±„í˜ˆì§€ì›">ì±„í˜ˆì§€ì›</option><option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
          <input type="text" id="customPrevention" placeholder="ì˜ˆë°©ë‚´ì—­ ì§ì ‘ ì…ë ¥" style="display:none; margin-top:8px;">
        </div>

        <div class="form-group">
          <label>4. ê·¼ë¬´ì</label>
          <input type="text" id="workerInput" placeholder="ì˜ˆ) í™ê¸¸ë™ ì™¸ 1ëª…" required>
        </div>

        <div class="form-group">
          <label>5. ì‚¬ê³ ì</label>
          <input type="text" id="patientInput" placeholder="ì˜ˆ) ê¹€ì² ìˆ˜(69/ë‚¨)" required>
        </div>

        <div class="form-group">
          <label>6. ì¡°ì¹˜ê²°ê³¼</label>
          <textarea id="resultInput" placeholder="ì¡°ì¹˜í•˜ì‹  ê²°ê³¼ë¥¼ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”." required></textarea>
        </div>

        <div class="form-group">
          <label>7. ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
          <input type="file" id="photo1" accept="image/*">
        </div>

        <button type="submit" class="submit-btn">ë³´ê³  ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn1">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

    <div id="form2Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë’¤ë¡œ ê°€ê¸°</button>
      <div class="form-header"><h2>ë¯¸ì‹œê±´ ë° ì†Œë“± ì ê²€</h2></div>
      <form id="form2">
        <div class="form-group"><label>ì ê²€ ë‚´ìš©</label><textarea id="content2" placeholder="ì ê²€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required></textarea></div>
        <div class="form-group"><label>ì‚¬ì§„ ì²¨ë¶€</label><input type="file" id="photo2" accept="image/*"></div>
        <button type="submit" class="submit-btn">ì ê²€ ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn2">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

    <div id="form3Screen" class="screen">
      <button class="back-btn" onclick="showScreen('homeScreen')">â—€ ë’¤ë¡œ ê°€ê¸°</button>
      <div class="form-header"><h2>ì‘ì—… í˜„í™© ë³´ê³ </h2></div>
      <form id="form3">
        <div class="form-group"><label>ì‘ì—… ë‚´ìš©</label><textarea id="content3" placeholder="í˜„í™© ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." required></textarea></div>
        <div class="form-group"><label>ì‚¬ì§„ ì²¨ë¶€</label><input type="file" id="photo3" accept="image/*"></div>
        <button type="submit" class="submit-btn">í˜„í™© ì œì¶œí•˜ê¸°</button>
        <button type="button" class="undo-btn" id="undoBtn3">ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš© ì‚­ì œ</button>
      </form>
    </div>

  </div>

  <script>
    // â˜… ì£¼ì˜: ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxK9_OtEHMpThIjXP6bUwi5j_cEMoFN9tDsd69qavXceqnq8fxWzJruMYpreuk8dUMS7A/exec';
    
    // UUID (ì‚­ì œìš©)
    let lastUuid1 = null; let lastUuid2 = null; let lastUuid3 = null;

    // ë‚ ì§œ í¬ë§·íŒ…: MM/DD(ìš”ì¼) - ì˜ˆ: 02/26(ëª©)
    function getFormattedDate() {
      const now = new Date();
      now.setMinutes(now.getMinutes() + (9 * 60)); // KST ë³´ì •
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const date = String(now.getDate()).padStart(2, '0');
      const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const day = days[now.getDay()];
      return `${month}/${date}(${day})`;
    }

    // ì•± í™”ë©´ ì „í™˜ í•¨ìˆ˜
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // ì´ˆê¸° ì„¸íŒ…
    window.addEventListener('load', () => {
      document.getElementById('dateDisplay').value = getFormattedDate();
      
      // ìë™ ë³µêµ¬ (ê·¼ë¬´ì ì´ë¦„ë§Œ ê¸°ì–µí•˜ë„ë¡ ì„¸íŒ…)
      const savedWorker = localStorage.getItem('autosave_worker');
      if(savedWorker) document.getElementById('workerInput').value = savedWorker;
    });

    // ë“œë¡­ë‹¤ìš´ 'ì§ì ‘ì…ë ¥' ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleDirectInput(selectId, inputId) {
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      select.addEventListener('change', function() {
        if(this.value === 'ì§ì ‘ì…ë ¥') { input.style.display = 'block'; input.required = true; } 
        else { input.style.display = 'none'; input.required = false; input.value = ''; }
      });
    }
    handleDirectInput('typeSelect', 'customType');
    handleDirectInput('preventionSelect', 'customPrevention');

    // ê³µí†µ ì œì¶œ í•¨ìˆ˜ (ì–´ëŠ ì‹œíŠ¸ë¡œ ë³´ë‚¼ì§€ sheetName ìœ¼ë¡œ ê²°ì •)
    async function submitForm(formId, sheetName, dataObj, photoInputId, undoBtnId) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      const fileInput = document.getElementById(photoInputId);
      
      const handleFile = () => {
        return new Promise((resolve) => {
          const file = fileInput.files[0];
          if (!file) { resolve(); return; }
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              const canvas = document.createElement('canvas');
              let w = img.width, h = img.height;
              if (w > 1024) { h = Math.round(h * 1024 / w); w = 1024; }
              canvas.width = w; canvas.height = h;
              canvas.getContext('2d').drawImage(img, 0, 0, w, h);
              dataObj.fileData = canvas.toDataURL('image/jpeg', 0.8);
              dataObj.fileName = file.name;
              resolve();
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      try {
        await handleFile();
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dataObj) });
        alert(sheetName + ' ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById(undoBtnId).style.display = 'block';
        return true;
      } catch (error) {
        alert('ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); return false;
      } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }

    // 1ë²ˆ: ìƒí™©ë³´ê³  í¼ ì „ì†¡
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      let finalType = document.getElementById('typeSelect').value;
      if (finalType === 'ì§ì ‘ì…ë ¥') finalType = document.getElementById('customType').value;
      
      let finalPrev = document.getElementById('preventionSelect').value;
      if (finalPrev === 'ì§ì ‘ì…ë ¥') finalPrev = document.getElementById('customPrevention').value;

      lastUuid1 = Date.now().toString(36);
      localStorage.setItem('autosave_worker', document.getElementById('workerInput').value); // ê·¼ë¬´ì ì´ë¦„ ì €ì¥

      const submitData = {
        action: 'insert',
        sheetName: 'ìƒí™©ë³´ê³ ', // ì‹œíŠ¸ ì´ë¦„ ë¶„ë°°ê¸°
        uuid: lastUuid1,
        date: document.getElementById('dateDisplay').value, // 02/26(ëª©)
        type: finalType,
        prevention: finalPrev,
        worker: document.getElementById('workerInput').value,
        patient: document.getElementById('patientInput').value,
        resultText: document.getElementById('resultInput').value
      };

      if(await submitForm('reportForm', 'ìƒí™©ë³´ê³ ', submitData, 'photo1', 'undoBtn1')) {
        // ì„±ê³µ ì‹œ ë‚´ìš© ì´ˆê¸°í™”
        this.reset();
        document.getElementById('dateDisplay').value = getFormattedDate(); // ë‚ ì§œ ë‹¤ì‹œ ì±„ìš°ê¸°
        document.getElementById('workerInput').value = localStorage.getItem('autosave_worker'); // ì´ë¦„ ìœ ì§€
        document.getElementById('customType').style.display = 'none';
        document.getElementById('customPrevention').style.display = 'none';
      }
    });

    // 2ë²ˆ: ë¯¸ì‹œê±´ ì†Œë“± ì „ì†¡ (ì„ì‹œ)
    document.getElementById('form2').addEventListener('submit', async function(e) {
      e.preventDefault();
      lastUuid2 = Date.now().toString(36);
      const data = { action: 'insert', sheetName: 'ë¯¸ì‹œê±´ë°ì†Œë“±', uuid: lastUuid2, date: getFormattedDate(), content: document.getElementById('content2').value };
      if(await submitForm('form2', 'ë¯¸ì‹œê±´ë°ì†Œë“±', data, 'photo2', 'undoBtn2')) this.reset();
    });

    // 3ë²ˆ: ì‘ì—… í˜„í™© ì „ì†¡ (ì„ì‹œ)
    document.getElementById('form3').addEventListener('submit', async function(e) {
      e.preventDefault();
      lastUuid3 = Date.now().toString(36);
      const data = { action: 'insert', sheetName: 'ì‘ì—…í˜„í™©', uuid: lastUuid3, date: getFormattedDate(), content: document.getElementById('content3').value };
      if(await submitForm('form3', 'ì‘ì—…í˜„í™©', data, 'photo3', 'undoBtn3')) this.reset();
    });

    // ê³µí†µ: ì‚­ì œ ë²„íŠ¼ ê¸°ëŠ¥
    async function handleUndo(sheetName, uuid, btnId) {
      if(!confirm('ë°©ê¸ˆ ì œì¶œí•œ ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      document.getElementById('loadingOverlay').style.display = 'flex';
      try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', sheetName: sheetName, uuid: uuid }) });
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); document.getElementById(btnId).style.display = 'none';
      } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); } finally { document.getElementById('loadingOverlay').style.display = 'none'; }
    }
    
    document.getElementById('undoBtn1').addEventListener('click', () => handleUndo('ìƒí™©ë³´ê³ ', lastUuid1, 'undoBtn1'));
    document.getElementById('undoBtn2').addEventListener('click', () => handleUndo('ë¯¸ì‹œê±´ë°ì†Œë“±', lastUuid2, 'undoBtn2'));
    document.getElementById('undoBtn3').addEventListener('click', () => handleUndo('ì‘ì—…í˜„í™©', lastUuid3, 'undoBtn3'));

  </script>
</body>
</html>
